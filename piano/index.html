<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ãƒ©ãƒ³ãƒ€ãƒ çŸ­ãƒ•ãƒ¬ãƒ¼ã‚ºç·´ç¿’ã‚¢ãƒ—ãƒªï½œCãƒ¡ã‚¸ãƒ£ãƒ¼ï¼4åˆ†ã®4æ‹å­</title>

  <style>
    :root {
      --bg: #0b0f14; --panel: #121a22; --ink: #eaf2ff; --sub: #a9b6c6; --accent:#3aa1ff;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,
        "Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic UI","Meiryo UI",sans-serif;
      background:var(--bg);color:var(--ink);
    }
    header{
      padding:16px 20px;
      border-bottom:1px solid #1e2a36;
      background:linear-gradient(180deg,#0c131a,#0a0f14)
    }
    h1{margin:0;font-size:18px;letter-spacing:.02em}
    main{display:grid;gap:16px;padding:16px}
    .card{background:var(--panel);border:1px solid #1b2632;border-radius:14px;padding:16px}
    .controls{display:grid;grid-template-columns:repeat(6,minmax(0,1fr));gap:12px;align-items:end}
    .controls .field{display:flex;flex-direction:column;gap:6px}
    label{font-size:12px;color:var(--sub)}
    select,button,input[type="number"],.seg{
      background:#0e151d;border:1px solid #1d2a38;color:var(--ink);
      border-radius:10px;padding:10px 12px;font-size:14px
    }
    button{cursor:pointer}
    button.primary{background:var(--accent);border:none;color:#00131f;font-weight:700}
    .seg{display:flex;gap:2px;padding:2px}
    .seg input{display:none}
    .seg label{
      cursor:pointer;color:var(--ink);padding:6px 10px;border-radius:8px;
      font-size:13px;border:1px solid transparent
    }
    .seg input:checked + label{background:#193045;border-color:#2d4e6a}
    .row{display:flex;gap:16px;align-items:center;flex-wrap:wrap}
    #score{
      overflow:auto;background:#0d141b;border:1px dashed #223142;
      border-radius:12px;padding:12px;min-height:140px
    }
    .footer{
      display:flex;justify-content:space-between;align-items:center;
      color:var(--sub);font-size:12px
    }
    .hint{font-size:12px;color:var(--sub)}
    .kbd{
      display:inline-block;padding:0 6px;border:1px solid #2b3b4c;border-radius:6px;
      background:#0f1821;color:#a9b6c6
    }
    .tiny{font-size:11px;color:#88a}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
      "Liberation Mono","Courier New", monospace}
    @media (max-width:900px){
      .controls{grid-template-columns:repeat(2,minmax(0,1fr))}
    }
  </style>
</head>
<body>
  <header>
    <h1>ãƒ©ãƒ³ãƒ€ãƒ çŸ­ãƒ•ãƒ¬ãƒ¼ã‚ºç·´ç¿’ã‚¢ãƒ—ãƒªï¼ˆCãƒ¡ã‚¸ãƒ£ãƒ¼ï¼4åˆ†ã®4æ‹å­ï¼‰</h1>
  </header>
  <main>
    <section class="card">
      <div class="controls">
        <div class="field">
          <label>ãƒ¢ãƒ¼ãƒ‰ï¼ˆæ‰‹ï¼‰</label>
          <div class="seg" role="radiogroup" aria-label="æ‰‹ã®ãƒ¢ãƒ¼ãƒ‰">
            <input type="radio" name="mode" id="mode-rh" value="RH" checked>
            <label for="mode-rh">å³æ‰‹</label>
            <input type="radio" name="mode" id="mode-lh" value="LH">
            <label for="mode-lh">å·¦æ‰‹</label>
            <input type="radio" name="mode" id="mode-both" value="BOTH">
            <label for="mode-both">ä¸¡æ‰‹</label>
          </div>
        </div>
        <div class="field">
          <label>é›£æ˜“åº¦ï¼ˆ1ã‚„ã•ã—ã„ â†’ 5ã‚„ã‚„ã‚€ãšã‹ã—ã„ï¼‰</label>
          <select id="difficulty" aria-label="é›£æ˜“åº¦">
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3" selected>3</option>
            <option value="4">4</option>
            <option value="5">5</option>
          </select>
        </div>
        <div class="field">
          <label>å°ç¯€æ•°</label>
          <div class="seg" role="radiogroup" aria-label="å°ç¯€æ•°">
            <input type="radio" name="bars" id="bars-1" value="1" checked>
            <label for="bars-1">1</label>
            <input type="radio" name="bars" id="bars-2" value="2">
            <label for="bars-2">2</label>
          </div>
        </div>
        <div class="field">
          <label>ãƒªã‚ºãƒ ã®ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆâ€»ã„ã¾ã¯4åˆ†éŸ³ç¬¦ã®ã¿ï¼‰</label>
          <select id="rhythmSeed" aria-label="ãƒªã‚ºãƒ ã®ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³">
            <option value="auto" selected>ãŠã¾ã‹ã›</option>
            <option value="quarters">4åˆ†éŸ³ç¬¦ã®ã¿</option>
          </select>
        </div>
        <div class="field">
          <label>å†ç¾ã‚·ãƒ¼ãƒ‰ï¼ˆä»»æ„ï¼‰</label>
          <input type="number" id="seed" placeholder="ä¾‹: 12345" class="mono" />
        </div>
        <div class="field">
          <button id="generate" class="primary">ãƒ©ãƒ³ãƒ€ãƒ ç”Ÿæˆ</button>
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <span class="hint">
          éµç›¤ç¯„å›²ï¼šå³æ‰‹ C4ã€œG5ï¼å·¦æ‰‹ C2ã€œG3ï¼ˆé›£æ˜“åº¦ã§å¯å¤‰ï¼‰ã€‚è‡¨æ™‚è¨˜å·ãªã—ï¼ˆãƒé•·èª¿ï¼‰ã€‚ç¾åœ¨ã¯4åˆ†éŸ³ç¬¦ã®ã¿ã€‚
        </span>
      </div>
    </section>

    <section id="score" class="card" aria-live="polite">
      <!-- canvas ã‚’ã“ã“ã«ä½œã‚Šã¾ã™ -->
    </section>

    <section class="card footer">
      <div>
        <span class="tiny">Â© GitHub Pages ã«ãã®ã¾ã¾ç½®ã‘ã‚‹å˜ä¸€HTMLã€‚å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªä¸ä½¿ç”¨ã€‚</span>
      </div>
      <div class="tiny">
        ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆï¼š<span class="kbd">G</span> ã§ç”Ÿæˆï¼
        <span class="kbd">1â€“5</span> ã§é›£æ˜“åº¦
      </div>
    </section>
  </main>

  <script>
  'use strict';

  // ---- ç°¡æ˜“ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºï¼ˆç”»é¢ä¸‹ã«å‡ºã™ï¼‰ ----
  window.addEventListener('error', function(e){
    var div = document.getElementById('score');
    if(!div) return;
    div.innerHTML = '';
    var pre = document.createElement('pre');
    pre.textContent = 'ã‚¨ãƒ©ãƒ¼: ' + (e.error && e.error.stack ? e.error.stack : (e.message || e));
    pre.style.color = '#ff9da4';
    pre.style.whiteSpace = 'pre-wrap';
    pre.style.padding = '8px';
    pre.style.border = '1px solid #3a1a1a';
    pre.style.background = '#190f0f';
    pre.style.borderRadius = '8px';
    div.appendChild(pre);
  });

  // ---- RNGï¼ˆã‚·ãƒ¼ãƒ‰ä»˜ãï¼‰ ----
  function mulberry32(a){
    return function(){
      var t=a+=0x6D2B79F5;
      t=Math.imul(t^t>>>15,t|1);
      t^=t+Math.imul(t^t>>>7,t|61);
      return ((t^t>>>14)>>>0)/4294967296;
    };
  }
  function pick(rng, arr){ return arr[Math.floor(rng()*arr.length)]; }

  // ---- éŸ³éš & éŸ³åŸŸå®šç¾© ----
  var SCALE = ['c','d','e','f','g','a','b'];

  var RH_RANGES = {
    1: {lo: {n:'c',o:4}, hi: {n:'g',o:5}},
    2: {lo: {n:'c',o:4}, hi: {n:'a',o:5}},
    3: {lo: {n:'b',o:3}, hi: {n:'b',o:5}},
    4: {lo: {n:'a',o:3}, hi: {n:'c',o:6}},
    5: {lo: {n:'g',o:3}, hi: {n:'d',o:6}}
  };
  var LH_RANGES = {
    1: {lo: {n:'c',o:2}, hi: {n:'g',o:3}},
    2: {lo: {n:'b',o:1}, hi: {n:'a',o:3}},
    3: {lo: {n:'a',o:1}, hi: {n:'b',o:3}},
    4: {lo: {n:'g',o:1}, hi: {n:'c',o:4}},
    5: {lo: {n:'f',o:1}, hi: {n:'d',o:4}}
  };

  function rankOf(n,o){
    return o * 7 + SCALE.indexOf(n);
  }
  function rankToNote(rank){
    var o = Math.floor(rank / 7);
    var idx = rank % 7;
    return { name: SCALE[idx], octave: o };
  }
  function clampRank(range, rank){
    var lo = rankOf(range.lo.n, range.lo.o);
    var hi = rankOf(range.hi.n, range.hi.o);
    if(rank < lo) rank = lo;
    if(rank > hi) rank = hi;
    return rank;
  }

  // ---- ãƒ¡ãƒ­ãƒ‡ã‚£ç”Ÿæˆï¼ˆ4åˆ†éŸ³ç¬¦ã ã‘ï¼‰ ----
  function generateMelody(range, difficulty, bars, rng){
    var notesPerBar = 4;
    var totalNotes = notesPerBar * bars;
    var notes = [];

    var maxStep = (difficulty <= 2) ? 2 :
                  (difficulty === 3) ? 3 :
                  (difficulty === 4) ? 4 : 5;

    var loRank = rankOf(range.lo.n, range.lo.o);
    var hiRank = rankOf(range.hi.n, range.hi.o);
    var curRank = Math.round((loRank + hiRank) / 2);

    for(var i=0;i<totalNotes;i++){
      var step = Math.floor(rng() * (maxStep*2 + 1)) - maxStep; // -max..+max
      if(step === 0){
        step = (rng() < 0.5) ? 1 : -1;
      }
      curRank = clampRank(range, curRank + step);
      var note = rankToNote(curRank);
      notes.push(note);
    }
    return notes;
  }

  // ---- äº”ç·š & éŸ³ç¬¦æç”» ----
  var LINE_GAP = 10;      // äº”ç·šã®ç·šé–“
  var STEP_HEIGHT = LINE_GAP / 2; // éŸ³ç¬¦ã®1åº¦ä¸Šä¸‹

  function getNoteY(clef, name, octave, staffTop){
    var rank = rankOf(name, octave);
    var refRank, refY;

    if(clef === 'treble'){
      // ãƒˆéŸ³è¨˜å·ï¼šB4ï¼ˆ3æœ¬ç›®ï¼‰ã‚’åŸºæº–
      refRank = rankOf('b', 4);
    }else{
      // ãƒ˜éŸ³è¨˜å·ï¼šD3ï¼ˆ3æœ¬ç›®ï¼‰ã‚’åŸºæº–
      refRank = rankOf('d', 3);
    }
    refY = staffTop + LINE_GAP * 2; // 3æœ¬ç›®ã®ç·š
    var steps = rank - refRank;
    return refY - steps * STEP_HEIGHT;
  }

  function drawStaff(ctx, staffTop, staffWidth, leftMargin, clef, bars){
    var x0 = leftMargin;
    var x1 = leftMargin + staffWidth;
    ctx.strokeStyle = '#6c7a89';
    ctx.lineWidth = 1;

    // äº”ç·š
    for(var i=0;i<5;i++){
      var y = staffTop + i*LINE_GAP;
      ctx.beginPath();
      ctx.moveTo(x0, y);
      ctx.lineTo(x1, y);
      ctx.stroke();
    }

    // å°ç¯€ç·š
    for(var b=0;b<=bars;b++){
      var bx = leftMargin + staffWidth * (b / bars);
      ctx.beginPath();
      ctx.moveTo(bx, staffTop);
      ctx.lineTo(bx, staffTop + LINE_GAP*4);
      ctx.stroke();
    }

    // éŸ³éƒ¨è¨˜å·ã¨æ‹å­
    ctx.fillStyle = '#eaf2ff';
    ctx.font = '28px serif';
    var clefChar = (clef === 'treble') ? 'ğ„' : 'ğ„¢';
    ctx.fillText(clefChar, 20, staffTop + LINE_GAP*4 - 2);

    ctx.font = '16px sans-serif';
    ctx.fillText('4', 42, staffTop + LINE_GAP*1.7);
    ctx.fillText('4', 42, staffTop + LINE_GAP*3.0);
  }

  function drawNotes(ctx, notes, clef, staffTop, staffWidth, leftMargin, bars){
    var totalNotes = notes.length;
    if(totalNotes === 0) return;
    var spacing = staffWidth / (totalNotes + 1);

    ctx.fillStyle = '#eaf2ff';
    ctx.strokeStyle = '#eaf2ff';
    ctx.lineWidth = 1.5;

    for(var i=0;i<totalNotes;i++){
      var x = leftMargin + spacing * (i+1);
      var n = notes[i];
      var y = getNoteY(clef, n.name, n.octave, staffTop);

      // éŸ³ç¬¦ã®ç‰
      ctx.beginPath();
      ctx.ellipse(x, y, 6, 4, -0.4, 0, Math.PI*2);
      ctx.fill();

      // æ£’ï¼ˆä¸Šå‘ãï¼‰
      ctx.beginPath();
      ctx.moveTo(x + 6, y);
      ctx.lineTo(x + 6, y - 28);
      ctx.stroke();
    }
  }

  // ---- ãƒ•ãƒ¬ãƒ¼ã‚ºç”Ÿæˆå…¨ä½“ ----
  function generatePhrase(opts){
    var mode = opts.mode;
    var difficulty = opts.difficulty;
    var bars = opts.bars;
    var seed = opts.seed;
    var rng = seed ? mulberry32(Number(seed)>>>0) : function(){ return Math.random(); };

    var scoreDiv = document.getElementById('score');
    scoreDiv.innerHTML = '';

    var canvas = document.createElement('canvas');
    canvas.id = 'scoreCanvas';
    var width = Math.max(600, scoreDiv.clientWidth - 40);
    var height = (mode === 'BOTH') ? 260 : 160;
    canvas.width = width;
    canvas.height = height;
    scoreDiv.appendChild(canvas);

    var ctx = canvas.getContext('2d');
    ctx.clearRect(0,0,width,height);

    var leftMargin = 70;
    var staffWidth = width - leftMargin - 20;

    if(mode === 'RH'){
      var staffTop = 40;
      drawStaff(ctx, staffTop, staffWidth, leftMargin, 'treble', bars);
      var rhRange = RH_RANGES[difficulty];
      var rhNotes = generateMelody(rhRange, difficulty, bars, rng);
      drawNotes(ctx, rhNotes, 'treble', staffTop, staffWidth, leftMargin, bars);

    }else if(mode === 'LH'){
      var staffTop2 = 40;
      drawStaff(ctx, staffTop2, staffWidth, leftMargin, 'bass', bars);
      var lhRange = LH_RANGES[difficulty];
      var lhNotes = generateMelody(lhRange, difficulty, bars, rng);
      drawNotes(ctx, lhNotes, 'bass', staffTop2, staffWidth, leftMargin, bars);

    }else if(mode === 'BOTH'){
      var trebleTop = 30;
      var bassTop = 140;

      drawStaff(ctx, trebleTop, staffWidth, leftMargin, 'treble', bars);
      drawStaff(ctx, bassTop, staffWidth, leftMargin, 'bass', bars);

      var rhRange2 = RH_RANGES[difficulty];
      var lhRange2 = LH_RANGES[difficulty];
      var rhNotes2 = generateMelody(rhRange2, difficulty, bars, rng);
      var lhNotes2 = generateMelody(lhRange2, difficulty, bars, rng);

      drawNotes(ctx, rhNotes2, 'treble', trebleTop, staffWidth, leftMargin, bars);
      drawNotes(ctx, lhNotes2, 'bass', bassTop, staffWidth, leftMargin, bars);

      // ï¼ˆå¤§æ‹¬å¼§ã¯çœç•¥ï¼šã¾ãšã¯éŸ³ç¬¦è¡¨ç¤ºã‚’å„ªå…ˆï¼‰
    }
  }

  // ---- UI wiring ----
  function $(sel){ return document.querySelector(sel); }

  function currentOptions(){
    var mode = document.querySelector('input[name="mode"]:checked').value;
    var difficulty = Number($('#difficulty').value);
    var bars = Number(document.querySelector('input[name="bars"]:checked').value);
    var seed = $('#seed').value.trim();
    var bias = $('#rhythmSeed').value; // ã„ã¾ã¯æœªä½¿ç”¨
    return { mode: mode, difficulty: difficulty, bars: bars, seed: (seed || null), bias: bias };
  }

  function doGen(){ generatePhrase(currentOptions()); }

  document.getElementById('generate').addEventListener('click', doGen);
  window.addEventListener('keydown', function(e){
    var k = (e.key || '').toLowerCase();
    if(k === 'g'){
      e.preventDefault();
      doGen();
    }
    if(e.key >= '1' && e.key <= '5'){
      document.getElementById('difficulty').value = e.key;
      doGen();
    }
  });

  // åˆå›æç”»
  generatePhrase(currentOptions());
  </script>
</body>
</html>
