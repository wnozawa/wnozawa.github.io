<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ランダム短フレーズ練習アプリ｜Cメジャー／4分の4拍子</title>
  <!-- VexFlow v3 UMD（譜面描画用） -->
  <script src="https://cdn.jsdelivr.net/npm/vexflow@3.0.9/build/vexflow-min.js"></script>
  <style>
    :root {
      --bg: #0b0f14; --panel: #121a22; --ink: #eaf2ff; --sub: #a9b6c6; --accent:#3aa1ff;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic UI","Meiryo UI",sans-serif;background:var(--bg);color:var(--ink);}
    header{padding:16px 20px;border-bottom:1px solid #1e2a36;background:linear-gradient(180deg,#0c131a,#0a0f14)}
    h1{margin:0;font-size:18px;letter-spacing:.02em}
    main{display:grid;gap:16px;padding:16px}
    .card{background:var(--panel);border:1px solid #1b2632;border-radius:14px;padding:16px}
    .controls{display:grid;grid-template-columns:repeat(6,minmax(0,1fr));gap:12px;align-items:end}
    .controls .field{display:flex;flex-direction:column;gap:6px}
    label{font-size:12px;color:var(--sub)}
    select,button,input[type="number"],.seg{background:#0e151d;border:1px solid #1d2a38;color:var(--ink);border-radius:10px;padding:10px 12px;font-size:14px}
    button{cursor:pointer}
    button.primary{background:var(--accent);border:none;color:#00131f;font-weight:700}
    .seg{display:flex;gap:2px;padding:2px}
    .seg input{display:none}
    .seg label{cursor:pointer;color:var(--ink);padding:6px 10px;border-radius:8px;font-size:13px;border:1px solid transparent}
    .seg input:checked + label{background:#193045;border-color:#2d4e6a}
    .row{display:flex;gap:16px;align-items:center;flex-wrap:wrap}
    #score{overflow:auto;background:#0d141b;border:1px dashed #223142;border-radius:12px;padding:12px}
    .footer{display:flex;justify-content:space-between;align-items:center;color:var(--sub);font-size:12px}
    .hint{font-size:12px;color:var(--sub)}
    .kbd{display:inline-block;padding:0 6px;border:1px solid #2b3b4c;border-radius:6px;background:#0f1821;color:#a9b6c6}
    .tiny{font-size:11px;color:#88a}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
  </style>
</head>
<body>
  <header>
    <h1>ランダム短フレーズ練習アプリ（Cメジャー／4分の4拍子）</h1>
  </header>
  <main>
    <section class="card">
      <div class="controls">
        <div class="field">
          <label>モード（手）</label>
          <div class="seg" role="radiogroup" aria-label="手のモード">
            <input type="radio" name="mode" id="mode-rh" value="RH" checked>
            <label for="mode-rh">右手</label>
            <input type="radio" name="mode" id="mode-lh" value="LH">
            <label for="mode-lh">左手</label>
            <input type="radio" name="mode" id="mode-both" value="BOTH">
            <label for="mode-both">両手</label>
          </div>
        </div>
        <div class="field">
          <label>難易度（1やさしい → 5ややむずかしい）</label>
          <select id="difficulty" aria-label="難易度">
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3" selected>3</option>
            <option value="4">4</option>
            <option value="5">5</option>
          </select>
        </div>
        <div class="field">
          <label>小節数</label>
          <div class="seg" role="radiogroup" aria-label="小節数">
            <input type="radio" name="bars" id="bars-1" value="1" checked>
            <label for="bars-1">1</label>
            <input type="radio" name="bars" id="bars-2" value="2">
            <label for="bars-2">2</label>
          </div>
        </div>
        <div class="field">
          <label>リズムのバリエーション</label>
          <select id="rhythmSeed" aria-label="リズムのバリエーション">
            <option value="auto" selected>おまかせ</option>
            <option value="quarters">4分音符中心</option>
            <option value="halves">2分音符あり</option>
            <option value="eighths">8分音符あり</option>
            <option value="chords">和音あり</option>
          </select>
        </div>
        <div class="field">
          <label>再現シード（任意）</label>
          <input type="number" id="seed" placeholder="例: 12345" class="mono" />
        </div>
        <div class="field">
          <button id="generate" class="primary">ランダム生成</button>
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <span class="hint">鍵盤範囲：右手 C4〜G5／左手 C2〜G3（難易度で可変）。臨時記号なし（ハ長調）。</span>
      </div>
    </section>

    <section id="score" class="card" aria-live="polite">
      <!-- SVG score will be injected here -->
    </section>

    <section class="card footer">
      <div>
        <span class="tiny">© あなたのGitHub Pagesにそのまま置ける単一HTML。VexFlow 3 を使用。</span>
      </div>
      <div class="tiny">ショートカット：<span class="kbd">G</span> で生成／<span class="kbd">1–5</span> で難易度</div>
    </section>
  </main>

  <script>
  // ===== RNG（シード付き） =====
  function mulberry32(a){return function(){var t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return ((t^t>>>14)>>>0)/4294967296}}
  function pick(rng, arr){return arr[Math.floor(rng()*arr.length)]}

  // ===== 音域と度数（Cメジャーのみ） =====
  // VexFlow のキー指定は 'c/4' のように表記。
  const SCALE = ['c','d','e','f','g','a','b'];
  const RH_RANGES = {
    1: {lo: {n:'c',o:4}, hi: {n:'g',o:5}},
    2: {lo: {n:'c',o:4}, hi: {n:'a',o:5}},
    3: {lo: {n:'b',o:3}, hi: {n:'b',o:5}},
    4: {lo: {n:'a',o:3}, hi: {n:'c',o:6}},
    5: {lo: {n:'g',o:3}, hi: {n:'d',o:6}},
  };
  const LH_RANGES = {
    1: {lo: {n:'c',o:2}, hi: {n:'g',o:3}},
    2: {lo: {n:'b',o:1}, hi: {n:'a',o:3}},
    3: {lo: {n:'a',o:1}, hi: {n:'b',o:3}},
    4: {lo: {n:'g',o:1}, hi: {n:'c',o:4}},
    5: {lo: {n:'f',o:1}, hi: {n:'d',o:4}},
  };

  function noteToString(n, o){return `${n}/${o}`}
  function within(range, n, o){
    const rank = (o*7) + SCALE.indexOf(n);
    const lo = (range.lo.o*7) + SCALE.indexOf(range.lo.n);
    const hi = (range.hi.o*7) + SCALE.indexOf(range.hi.n);
    return rank>=lo && rank<=hi;
  }

  function clampToRange(range, n, o){
    while(!within(range,n,o)){
      const loRank=(range.lo.o*7)+SCALE.indexOf(range.lo.n);
      const hiRank=(range.hi.o*7)+SCALE.indexOf(range.hi.n);
      const r=(o*7)+SCALE.indexOf(n);
      if(r<loRank){o++;} else if(r>hiRank){o--;}
    }
    return {n,o};
  }

  // ===== リズムパターン（各小節の合計4拍） =====
  // dur: 'w','h','q','8'（全／2分／4分／8分）; dots: 0/1（付点）; rest: true/false; chord: 0..3（和音の音数-1）
  function patternsFor(diff, bias){
    const P = [];
    const Q = v=>({dur:'q',dots:0,rest:false,chord:0,vol:v});
    const H = v=>({dur:'h',dots:0,rest:false,chord:0,vol:v});
    const Hd= v=>({dur:'h',dots:1,rest:false,chord:0,vol:v}); // 付点2分=3拍
    const W = v=>({dur:'w',dots:0,rest:false,chord:0,vol:v});
    const E = v=>({dur:'8',dots:0,rest:false,chord:0,vol:v});
    const RQ= v=>({dur:'q',dots:0,rest:true ,chord:0,vol:v});
    const RH= v=>({dur:'h',dots:0,rest:true ,chord:0,vol:v});

    // Level 1: 4分中心
    P.push([Q(),Q(),Q(),Q()]);
    P.push([H(),Q(),Q()]);
    P.push([Q(),H(),Q()]);
    P.push([H(),H()]);
    P.push([W()]);

    if(diff>=2){
      P.push([Hd(),Q()]);
      P.push([Q(),Hd()]);
      P.push([RQ(),H(),Q()]);
    }

    if(diff>=3){
      P.push([Q(),Q(),E(),E(),Q()]);
      P.push([E(),E(),Q(),Q(),Q()]);
      P.push([Q(),E(),E(),E(),E(),Q()]);
    }

    if(diff>=4){
      P.push([E(),E(),E(),E(),Q(),Q()]);
      P.push([Q(),Q(),RH(),Q()]);
    }

    if(diff>=5){
      P.push([E(),E(),E(),E(),E(),E(),Q(),Q()]);
      P.push([Hd(),E(),E()]);// 3拍+1拍
    }

    // bias でチョイスを軽く誘導
    if(bias==='quarters') return P.filter(x=>x.every(t=>t.dur==='q'||t.dur==='h'||t.dur==='w'||t.dots===1));
    if(bias==='halves')   return P.filter(x=>x.some(t=>t.dur==='h'||t.dots===1));
    if(bias==='eighths')  return P.filter(x=>x.some(t=>t.dur==='8'));
    if(bias==='chords')   return P; // 和音は後で付与
    return P;
  }

  // ===== フレーズ生成 =====
  function generatePhrase(opts){
    const {mode, difficulty, bars, seed, bias} = opts;
    const rng = seed? mulberry32(Number(seed)>>>0) : Math.random;

    const VF = Vex.Flow;
    const div = document.getElementById('score');
    div.innerHTML = '';

    const renderer = new VF.Renderer(div, VF.Renderer.Backends.SVG);
    const widthPerBar = 360; // 小節幅
    const staveHeight  = (mode==='BOTH')? 200 : 120;
    const width = Math.max(420, widthPerBar*bars + 40);
    renderer.resize(width, staveHeight);
    const context = renderer.getContext();

    // スタッフ作成
    const treble = new VF.Stave(10, 20, width-20).addClef('treble').addTimeSignature('4/4');
    let bass   = null;
    if(mode==='BOTH' || mode==='LH'){
      bass = new VF.Stave(10, (mode==='BOTH')? 120:20, width-20).addClef('bass').addTimeSignature('4/4');
    }

    if(mode==='BOTH'){
      treble.setContext(context).draw();
      bass.setContext(context).draw();
      // 大括弧
      const brace = new VF.StaveConnector(treble, bass).setType(VF.StaveConnector.type.BRACE);
      const lineL = new VF.StaveConnector(treble, bass).setType(VF.StaveConnector.type.SINGLE_LEFT);
      const lineR = new VF.StaveConnector(treble, bass).setType(VF.StaveConnector.type.SINGLE_RIGHT);
      brace.setContext(context).draw();
      lineL.setContext(context).draw();
      lineR.setContext(context).draw();
    } else {
      treble.setContext(context).draw();
      if(mode==='LH') bass.setContext(context).draw();
    }

    // それぞれの手のパートを作る
    const voices = [];

    function buildHand(hand){
      const range = (hand==='RH')? RH_RANGES[difficulty] : LH_RANGES[difficulty];
      const clef  = (hand==='RH')? 'treble':'bass';
      const measures = [];
      const patterns = patternsFor(difficulty, bias);
      let last = {n:'c', o:(hand==='RH'?4:2)}; // 出発点

      for(let m=0;m<bars;m++){
        const pat = pick(rng, patterns);
        const notes = [];\n        const beams = [];\n        let eighthGroup = [];

        pat.forEach((tok, idx)=>{
          const makeKeys = ()=>{
            // 音程の選び方：難易度でステップ幅を調整
            const maxStep = (difficulty<=2)? 2 : (difficulty===3? 3 : (difficulty===4? 4 : 5));
            let step = Math.floor(rng()*(maxStep*2+1)) - maxStep; // -max..+max
            if(Math.abs(step)===0) step = (rng()<0.5? 1:-1); // 完全な停止を避ける

            const curIdx = SCALE.indexOf(last.n) + last.o*7;
            let newIdx = curIdx + step;
            let n = SCALE[(newIdx%7+7)%7];
            let o = Math.floor(newIdx/7);
            // 範囲に収める
            ({n,o} = clampToRange(range, n, o));

            // 和音（上位レベル）
            let chordSize = 0;
            if(!tok.rest && difficulty>=3 && bias==='chords' || (!tok.rest && difficulty>=4 && rng()<0.25)){
              chordSize = (difficulty>=5 && rng()<0.4)? 2 : 1; // 2→三和音, 1→二和音
            }
            const keys = [noteToString(n,o)];
            if(chordSize>=1){ // 3度を重ねる
              const i2 = (SCALE.indexOf(n)+2)%7; const o2 = o + Math.floor((SCALE.indexOf(n)+2)/7);
              keys.push(noteToString(SCALE[i2], o2));
            }
            if(chordSize>=2){ // さらに5度
              const i3 = (SCALE.indexOf(n)+4)%7; const o3 = o + Math.floor((SCALE.indexOf(n)+4)/7);
              keys.push(noteToString(SCALE[i3], o3));
            }
            last = {n, o};
            return keys;
          };

          const dur = tok.dur + (tok.rest? 'r':'');
          const keys = tok.rest? [(hand==='RH')? 'b/4':'d/3'] : makeKeys(); // 休符用のダミーキー
          const note = new Vex.Flow.StaveNote({clef, keys, duration: dur});
          // 付点
          for(let d=0; d<tok.dots; d++) Vex.Flow.Dot.buildAndAttach([note], { all: true });
          // 和音用に自動的にヘッドを塗り分けたりしない（デフォルトでOK）
          notes.push(note);
          if(tok.dur==='8' && !tok.rest){ eighthGroup.push(note); }
          if(tok.dur!=='8' || tok.rest || idx===pat.length-1){
            if(eighthGroup.length>=2){
              beams.push(new Vex.Flow.Beam(eighthGroup));
            }
            eighthGroup = [];
          }
        });
        measures.push({notes, beams});
      }
      return {hand, clef, measures};
    }

    const useRH = (mode==='RH' || mode==='BOTH');
    const useLH = (mode==='LH' || mode==='BOTH');
    const RH = useRH? buildHand('RH') : null;
    const LH = useLH? buildHand('LH') : null;

    function layoutAndDraw(handPart, stave){
      const VF = Vex.Flow;
      const voices = [];
      handPart.measures.forEach((m, mi)=>{
        const voice = new VF.Voice({num_beats:4, beat_value:4}).setMode(VF.Voice.Mode.SOFT);
        voice.addTickables(m.notes);
        voices.push(voice);
      });
      // 各小節ごとにフォーマッタで整形
      let x = stave.getX() + 10;
      const y = stave.getY();
      const w = stave.getWidth();
      const per = (w-20)/bars;
      handPart.measures.forEach((notes, mi)=>{
        const st = new VF.Stave(x, y, per);
        st.setContext(context);
        st.setClef(handPart.clef);
        if(mi===0){ st.setTimeSignature('4/4'); }
        st.draw();
        const voice = new VF.Voice({num_beats:4, beat_value:4}).setMode(VF.Voice.Mode.SOFT);
        voice.addTickables(m.notes);
        new VF.Formatter().joinVoices([voice]).format([voice], per-40);
        voice.draw(context, st);\n        // ビームはフォーマッタ後に描画\n        m.beams.forEach(b=>{ b.setContext(context).draw(); });\n        x += per;
      });
    }

    if(mode==='BOTH'){
      layoutAndDraw(RH, treble);
      layoutAndDraw(LH, bass);
    } else if(mode==='RH'){
      layoutAndDraw(RH, treble);
    } else if(mode==='LH'){
      layoutAndDraw(LH, bass);
    }
  }

  // ===== UI wiring =====
  const $ = sel => document.querySelector(sel);
  function currentOptions(){
    const mode = document.querySelector('input[name="mode"]:checked').value;
    const difficulty = Number($('#difficulty').value);
    const bars = Number(document.querySelector('input[name="bars"]:checked').value);
    const seed = $('#seed').value.trim();
    const bias = $('#rhythmSeed').value;
    return {mode, difficulty, bars, seed: seed || null, bias};
  }
  function doGen(){ generatePhrase(currentOptions()); }
  $('#generate').addEventListener('click', doGen);
  // ショートカット
  window.addEventListener('keydown', (e)=>{
    if(e.key.toLowerCase()==='g'){ e.preventDefault(); doGen(); }
    if(e.key>='1' && e.key<='5'){ $('#difficulty').value = e.key; doGen(); }
  });

  // 初回描画
  generatePhrase(currentOptions());
  </script>
</body>
</html>
